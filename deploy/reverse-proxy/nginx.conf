server {
  # Must match the exposed port so Origin checks work (e.g. 80/5173).
  listen ${LISTEN_PORT};
  server_name _;

  # Allow large payloads (e.g., uploads/imports from the console).
  client_max_body_size 200m;

  # Console (static site, served by the `secrux-console` container).
  location / {
    proxy_pass http://secrux-console:80;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # API (Spring Boot).
  # `/api/projects` -> `http://secrux-server:8080/projects`
  location /api/ {
    proxy_pass http://secrux-server:8080/;
    proxy_http_version 1.1;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # Keycloak (OIDC endpoints used by the console).
  # `/auth/realms/...` -> `http://keycloak:8081/realms/...`
  location /auth/ {
    proxy_pass http://keycloak:8081/;
    proxy_http_version 1.1;
    # Keep token issuer stable for the backend resource server.
    proxy_set_header Host keycloak:8081;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }
}
