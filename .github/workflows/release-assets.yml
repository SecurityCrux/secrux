name: Release executor binaries

on:
  release:
    types: [published]

permissions:
  contents: write

concurrency:
  group: release-assets-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ""
            archive: tar.gz
          - runner: ubuntu-latest
            goos: linux
            goarch: arm64
            ext: ""
            archive: tar.gz
          - runner: windows-latest
            goos: windows
            goarch: amd64
            ext: ".exe"
            archive: zip
          - runner: macos-13
            goos: darwin
            goarch: amd64
            ext: ""
            archive: tar.gz
          - runner: macos-14
            goos: darwin
            goarch: arm64
            ext: ""
            archive: tar.gz
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install GCC (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc

      - name: Install cross-compiler (linux/arm64)
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross

      - name: Build archive
        env:
          TAG: ${{ github.event.release.tag_name }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          EXT: ${{ matrix.ext }}
          ARCHIVE: ${{ matrix.archive }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist

          name="executor-agent_${TAG}_${GOOS}_${GOARCH}"
          dir="dist/${name}"
          mkdir -p "${dir}"

          if [[ "${GOOS}" == "windows" ]]; then
            export CC="gcc"
          fi
          if [[ "${GOOS}" == "linux" && "${GOARCH}" == "arm64" ]]; then
            export CC="aarch64-linux-gnu-gcc"
          fi

          CGO_ENABLED=1 GOOS="${GOOS}" GOARCH="${GOARCH}" \
            go build -trimpath -ldflags="-s -w" -o "${dir}/executor-agent${EXT}" .

          cp -f LICENSE "${dir}/LICENSE"
          cp -f README.md "${dir}/README.md"
          cp -f config.temp "${dir}/config.temp"
          cp -f .env.example "${dir}/.env.example"

          if [[ "${ARCHIVE}" == "zip" ]]; then
            (
              cd dist
              python -m zipfile -c "${name}.zip" "${name}"
            )
            rm -rf "${dir}"
            exit 0
          fi

          tar -czf "dist/${name}.tar.gz" -C dist "${name}"
          rm -rf "${dir}"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: executor-agent_${{ matrix.goos }}_${{ matrix.goarch }}
          path: dist/*
          if-no-files-found: error

  upload:
    name: Upload release assets
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          files=( *.tar.gz *.zip )
          sha256sum "${files[@]}" > checksums.sha256

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.event.release.tag_name }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${TAG}" dist/* --clobber
